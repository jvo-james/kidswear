<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> April Blossoms</title>

  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-p8fXwXg6X0wq2b1vKxQk3y2p9CwqQxZl3s2s8xYQ7Kqg0q2QY2KxqQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Paystack & jsPDF (for receipt generation) -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Google Fonts: Raleway & Open Sans -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&family=Open+Sans&display=swap" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Animate.css for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<style>
  /* =========================
   April Blossoms — Main stylesheet
   Mobile-first, very responsive + polished
   ========================= */

/* ---------- Font import ---------- */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Inter:wght@300;400;600;700&display=swap');

/* ---------- Theme variables ---------- */
:root{
  --bg: #fffaf9;
  --muted-bg: #fff7f5;
  --surface: #ffffff;
  --card: #ffffff;
  --text: #0f1724;
  --muted: #6b6b73;
  --accent: #ff6b85;   /* coral/pink */
  --accent-2: #ff9ab8; /* softer */
  --accent-3: #6ee7b7; /* mint accent */
  --success: #0bb27a;
  --glass: rgba(255,255,255,0.85);
  --outline: rgba(15,20,28,0.06);
  --shadow-sm: 0 8px 28px rgba(15,20,28,0.06);
  --shadow-lg: 0 28px 80px rgba(15,20,28,0.12);
  --radius-lg: 16px;
  --radius-md: 10px;
  --radius-sm: 8px;
  --max-width: 1200px;
  --container-pad: 16px;
  --nav-height: 72px;
  --glass-border: rgba(255,154,184,0.12);
  --focus: 3px solid rgba(255,154,184,0.18);
}

/* ---------- Base ---------- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--muted-bg),var(--bg));font-family:'Poppins',Inter,system-ui,Arial,sans-serif;color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
img{max-width:100%;display:block}
a{color:inherit}
button{font-family:inherit}
.container{max-width:var(--max-width);margin:0 auto;padding:0 var(--container-pad)}

/* ---------- Header ---------- */
.site-header{
  position:sticky;top:0;z-index:1200;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.7));
  backdrop-filter: blur(6px);
  border-bottom:1px solid var(--outline);
  box-shadow: 0 4px 18px rgba(12,16,22,0.03);
  padding:10px 0;
}
.header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand .site-title{font-weight:700;font-size:16px;color:var(--text)}
.brand .tagline{font-size:12px;color:var(--muted);margin-top:2px}

/* header actions */
.header-actions{display:flex;align-items:center;gap:8px}
.header-actions .outline, .header-actions .btn{
  border-radius:999px;padding:8px 12px;font-weight:700;background:transparent;border:1px solid var(--outline);cursor:pointer;display:inline-flex;align-items:center;gap:8px;
}
.header-actions .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;box-shadow:0 10px 28px rgba(255,122,162,0.08)}
.header-actions .header-icon{position:relative;padding:8px}
.icon-badge{
  display:inline-block;min-width:20px;padding:2px 6px;border-radius:999px;background:var(--accent-3);color:#053d2a;font-weight:800;font-size:12px;text-align:center;margin-left:6px;box-shadow:0 6px 18px rgba(7,94,84,0.06);
}

/* search */
.search-wrap{display:flex;align-items:center;gap:8px}
.search-wrap input[type="search"]{padding:8px 10px;border-radius:999px;border:1px solid var(--outline);width:160px;font-size:14px}
.search-wrap button{padding:8px 10px;border-radius:999px}

/* ---------- HERO / SLIDES ---------- */
.hero{position:relative;overflow:hidden;border-radius:14px;margin:16px var(--container-pad)}
.hero-slides{position:relative}
.hero-slide{position:relative;display:block;overflow:hidden;border-radius:12px;margin-bottom:6px;transition:opacity .45s ease;opacity:0}
.hero-slide[aria-hidden="false"]{opacity:1}
.hero-slide img{width:100%;height:48vw;max-height:520px;object-fit:cover;border-radius:12px;display:block}

/* caption */
.hero-caption{position:absolute;left:14px;bottom:26px;background:linear-gradient(180deg,rgba(255,255,255,0.88),rgba(255,255,255,0.82));padding:12px 14px;border-radius:12px;box-shadow:var(--shadow-sm);max-width:86%}
.hero-caption h2{margin:0;font-size:18px;color:var(--text);font-weight:800}
.hero-caption p{margin:6px 0 0 0;color:var(--muted);font-size:13px}

/* controls */
.hero-controls{position:absolute;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;align-items:center;gap:12px}
.hero-indicators{display:flex;gap:8px}
.hero-dot{width:10px;height:10px;border-radius:999px;border:0;background:rgba(255,255,255,0.6);box-shadow:0 6px 18px rgba(0,0,0,0.06);cursor:pointer}
.hero-dot[aria-pressed="true"]{background:linear-gradient(90deg,var(--accent),var(--accent-2));width:14px;height:14px}

/* hero nav */
.hero-nav button{background:rgba(255,255,255,0.9);border:1px solid var(--outline);padding:8px;border-radius:999px;cursor:pointer}

/* ---------- MAIN: controls ---------- */
.controls{margin-top:6px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:12px}

/* view toggle + sort */
.view-toggle button{border-radius:8px;padding:8px}
.sort select{padding:8px;border-radius:8px;border:1px solid var(--outline)}

/* ---------- PRODUCT GRID ---------- */
.product-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.product-card{background:var(--card);border-radius:12px;padding:8px;border:1px solid var(--outline);box-shadow:var(--shadow-sm);display:flex;flex-direction:column;gap:8px;transition:transform .18s ease,box-shadow .18s ease}
.product-card:hover{transform:translateY(-6px);box-shadow:var(--shadow-lg)}
.card-media{position:relative}
.badge-available{font-size:12px;font-weight:800;background:linear-gradient(90deg,var(--accent-3),#baf6d9);padding:6px 8px;border-radius:8px;color:#053d2a}
.card-image{border-radius:10px}
.product-title{font-size:15px;margin:0}
.product-price{font-weight:800;color:var(--accent)}
.product-desc{font-size:13px;color:var(--muted);margin:0}

/* product actions */
.add-to-cart{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
.view-detail{background:transparent;border:1px solid var(--outline);padding:8px 10px;border-radius:10px}

/* show more buttons */
#showMoreBtn, #showLessBtn{padding:10px 16px;border-radius:10px}

/* ---------- CART PANEL (slide-out) ---------- */
.cart-panel{
  width:420px;max-width:96%;right:0;top:0;height:100vh;background:var(--surface);position:fixed;z-index:1400;box-shadow:var(--shadow-lg);transform:translateX(100%);transition:transform .32s cubic-bezier(.2,.9,.2,1);display:flex;flex-direction:column;padding:18px;overflow:auto;border-left:1px solid var(--outline);
}
.cart-panel[aria-hidden="false"], .cart-panel.open{transform:translateX(0)}
#cartItems{margin-top:12px;display:flex;flex-direction:column;gap:12px}

/* cart item row */
.cart-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.03)}
.cart-item img{width:64px;height:64px;object-fit:cover;border-radius:8px}
.cart-item .meta{flex:1}
.cart-item .meta .title{font-weight:700}
.cart-item .meta .price{color:var(--muted);font-weight:700}

/* totals */
.cart-totals{margin-top:auto;padding-top:12px;background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);border-top:1px solid var(--outline)}

/* coupon */
#couponInput{padding:8px;border-radius:8px;border:1px solid var(--outline)}

/* ---------- MODALS (checkout, receipt, history, quick view) ---------- */
.modal-backdrop{position:fixed;inset:0;background:rgba(11,15,20,0.45);display:flex;align-items:center;justify-content:center;padding:18px;z-index:1500}
.modal{width:100%;max-width:920px;background:var(--surface);border-radius:12px;padding:16px;border:1px solid var(--outline);box-shadow:var(--shadow-lg);overflow:auto;max-height:calc(100vh - 64px)}
.modal h2,h3{margin:0}

/* small modal variants */
.modal.small{max-width:480px}

/* modal actions */
.modal .btn{border-radius:10px;padding:10px 12px}
.modal .outline{border-radius:10px;padding:10px 12px}

/* receipt content */
#receiptContent{font-size:14px;color:var(--text)}

/* history content scroll */
#historyContent{max-height:60vh;overflow:auto}

/* quick view image */
.modal .product-large{width:100%;height:320px;object-fit:cover;border-radius:8px}

/* ---------- TOASTS ---------- */
#ab_toast_container{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:1600}
#ab_toast_container > div{background:#fff;padding:10px 12px;border-radius:10px;border:1px solid var(--outline);box-shadow:var(--shadow-sm);font-weight:700}

/* ---------- FOOTER ---------- */
#siteFooter{padding:28px 16px;border-top:1px solid rgba(0,0,0,0.04)}
#siteFooter h4{margin:0 0 8px 0}
#siteFooter a{color:rgba(255,255,255,0.9);text-decoration:none}
#siteFooter small{color:rgba(255,255,255,0.7)}

/* social icons */
.social{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.06);color:#fff}

/* ---------- BACK TO TOP ---------- */
#backToTop{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;border-radius:999px;padding:10px;box-shadow:var(--shadow-lg);cursor:pointer;display:none;z-index:1400}

/* ---------- SMALL SCREEN ADJUSTMENTS (mobile-first) ---------- */
@media (max-width:599px){
  .product-grid{grid-template-columns:repeat(1,1fr);gap:12px}
  .search-wrap input[type="search"]{width:120px}
  .hero-slide img{height:64vw}
  .hero-caption{left:12px;right:12px;bottom:18px;padding:10px}
  .header-inner{padding:0 6px}
  .cart-panel{width:100%;right:0;left:0;bottom:0;top:auto;height:auto;border-radius:12px 12px 0 0;transform:translateY(100%);transition:transform .32s ease-in-out;max-height:92vh}
  .cart-panel.open{transform:translateY(0)}
  .cart-panel[aria-hidden="false"]{transform:translateY(0)}
  .cart-totals{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);padding:12px;border-top:1px solid var(--outline)}
  .hero-controls{bottom:8px;left:12px;right:12px}
  .modal{max-width:96%;max-height:92vh}
  .product-card{flex-direction:row;align-items:center}
  .card-image{width:120px;height:120px;border-radius:10px}
  .product-desc{display:none} /* keep mobile cards compact; view shows details */
  .hero-caption h2{font-size:16px}
}

/* ---------- LARGER SCREEN LAYOUT ---------- */
@media (min-width:600px){
  .product-grid{grid-template-columns:repeat(2,1fr)}
  .hero-slide img{height:40vw}
  .product-card{flex-direction:column}
  .product-desc{display:block}
}

@media (min-width:900px){
  .product-grid{grid-template-columns:repeat(3,1fr);gap:18px}
  .header-inner{padding:0 12px}
  .search-wrap input[type="search"]{width:220px}
  .hero-caption h2{font-size:20px}
  .cart-panel{width:420px;right:18px;top:72px;height:calc(100vh - 92px);border-radius:12px}
}

/* ---------- ACCESSIBILITY (focus states) ---------- */
:focus{outline:none}
button:focus, input:focus, select:focus, textarea:focus{
  box-shadow: 0 6px 22px rgba(255,154,184,0.12);
  border-color: rgba(255,154,184,0.32);
  outline: var(--focus);
  outline-offset: 4px;
}

/* ---------- UTILITIES ---------- */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* ---------- SMALL POLISH ---------- */
/* subtle hover states */
.btn:hover{transform:translateY(-3px);transition:transform .16s ease}
.outline:hover{background:rgba(0,0,0,0.02)}
.product-card .add-to-cart:active,.btn:active{transform:translateY(-1px)}

/* set consistent input styles */
input, textarea, select{
  font-family:inherit;padding:10px;border-radius:8px;border:1px solid var(--outline);font-size:14px;background:transparent;
}

/* history & receipt layout small tweaks */
#historyContent > div{padding:8px}
#receiptContent code{background:rgba(0,0,0,0.03);padding:4px 6px;border-radius:6px}

/* ensure product images have placeholder look if missing */
.product-grid img[alt=""], .product-grid img[src="placeholder.jpg"]{background:linear-gradient(90deg,#f6f6f8,#fff);display:block}

/* make outline class readable when used as button in dark footer */
#siteFooter .outline{background:transparent;border:1px solid rgba(255,255,255,0.08);color:rgba(255,255,255,0.9)}

/* subtle decorative accent for hero */
.hero:before{content:"";position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,245,247,0.25));mix-blend-mode:overlay;border-radius:12px;}

/* ensure modal actions always visible on small screens */
.modal .modal-actions{position:sticky;bottom:0;padding-top:12px;background:linear-gradient(180deg,rgba(255,255,255,0),rgba(255,255,255,0.98));}

/* small links inside containers */
.muted{color:var(--muted);font-size:13px}

</style>
</head>
  <body>
  <!-- SITE WRAPPER -->
  <div id="siteRoot" class="site-root">

    <!-- HEADER -->
    <header id="siteHeader" class="site-header" role="banner" aria-label="April Blossoms header">
      <div class="container header-inner" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div class="brand" style="display:flex;align-items:center;gap:12px">
          <a href="#" class="logo-link" aria-label="April Blossoms home">
            <img src="logo.jpg" alt="April Blossoms logo" id="brandLogo" style="height:56px;width:56px;object-fit:cover;border-radius:8px"/>
          </a>
          <div>
            <h1 class="site-title" style="margin:0;font-size:18px">April Blossoms</h1>
            <p class="tagline" style="margin:0;font-size:13px;color:#666">Unique kidswear — one piece each</p>
          </div>
        </div>

        <div class="header-actions" style="display:flex;align-items:center;gap:10px">
          <!-- search -->
          <div class="search-wrap" role="search" aria-label="Search dresses">
            <input id="searchInput" type="search" placeholder="Search dresses (e.g. Floral Ruffles)" aria-label="Search dresses" />
            <button id="searchBtn" class="outline" aria-label="Search">Search</button>
          </div>

          <!-- history (badge shows number of past purchases -- JS will update #historyCount) -->
          <button id="historyBtn" class="outline header-icon" aria-haspopup="dialog" aria-controls="historyModal" title="Purchase history">
            <i class="fa-solid fa-clock-rotate-left" aria-hidden="true"></i>
            <span class="sr-only">Purchase history</span>
            <span id="historyCount" class="icon-badge" aria-hidden="true" style="display:inline-block;margin-left:6px;">0</span>
          </button>

          <!-- cart (badge shows items in cart JS updates #cartCount) -->
          <button id="cartBtn" class="outline header-icon" aria-haspopup="dialog" aria-controls="cartPanel" title="Open cart">
            <i class="fa-solid fa-shopping-cart" aria-hidden="true"></i>
            <span class="sr-only">Cart</span>
            <span id="cartCount" class="icon-badge" aria-hidden="true" style="display:inline-block;margin-left:6px;">0</span>
          </button>

          <!-- lightweight account/checkout anchor (optional) -->
          <a href="#contact" class="outline" id="contactHeaderBtn"><i class="fa-solid fa-phone" aria-hidden="true"></i> Contact</a>
        </div>
      </div>
    </header>

    <!-- HERO (slideshow) -->
    <section id="hero" class="hero" aria-label="Featured dresses" style="position:relative;overflow:hidden;">
      <div class="hero-slides" id="heroSlides" role="region" aria-roledescription="carousel" aria-label="April Blossoms hero slideshow">
        <!-- slides: JS can wire transitions; using dataset-index for accessibility -->
        <div class="hero-slide" data-index="0" aria-hidden="false" role="group" aria-roledescription="slide" aria-label="Slide 1 of 3">
          <img src="hero-1.jpg" alt="Model wearing Floral Ruffles dress" style="width:100%;height:520px;object-fit:cover" />
          <div class="hero-caption" aria-hidden="false">
            <h2>Handpicked one-off kidswear</h2>
            <p>Each dress is unique — only one available.</p>
            <button id="shopNowBtn" class="btn" aria-controls="productGrid">Shop the collection</button>
          </div>
        </div>

        <div class="hero-slide" data-index="1" aria-hidden="true" role="group" aria-roledescription="slide" aria-label="Slide 2 of 3">
          <img src="hero-2.jpg" alt="Blue sundress on display" style="width:100%;height:520px;object-fit:cover" />
          <div class="hero-caption" aria-hidden="true">
            <h2>Timeless pieces for little ones</h2>
            <p>Lightweight, breathable and lovingly made.</p>
            <button class="btn" aria-controls="productGrid">Browse dresses</button>
          </div>
        </div>

        <div class="hero-slide" data-index="2" aria-hidden="true" role="group" aria-roledescription="slide" aria-label="Slide 3 of 3">
          <img src="hero-4.jpg" alt="Cute embroidered detail close-up" style="width:100%;height:520px;object-fit:cover" />
          <div class="hero-caption" aria-hidden="true">
            <h2>Special occasion favorites</h2>
            <p>Perfect for birthdays, parties and family photos.</p>
            <button class="btn" aria-controls="productGrid">Explore</button>
          </div>
        </div>
      </div>

      <!-- controls -->
      <div class="hero-controls" aria-hidden="false" style="position:absolute;left:16px;right:16px;bottom:18px;display:flex;justify-content:space-between;align-items:center">
        <div class="hero-indicators" id="heroIndicators" role="tablist" aria-label="Slide indicators">
          <button class="hero-dot" data-slide="0" aria-label="Go to slide 1" aria-pressed="true"></button>
          <button class="hero-dot" data-slide="1" aria-label="Go to slide 2" aria-pressed="false"></button>
          <button class="hero-dot" data-slide="2" aria-label="Go to slide 3" aria-pressed="false"></button>
        </div>
        <div class="hero-nav">
          <button id="heroPrev" class="outline" aria-label="Previous slide"><i class="fa-solid fa-chevron-left"></i></button>
          <button id="heroNext" class="outline" aria-label="Next slide"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </section>

    <!-- MAIN CONTENT -->
    <main id="main" role="main" class="main-content" style="padding:28px 16px">
      <div class="container" style="max-width:1200px;margin:0 auto">
        <!-- Filters & top controls -->
        <div class="controls" style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px">
          <div style="display:flex;gap:8px;align-items:center">
            <div class="view-toggle" role="toolbar" aria-label="View controls">
              <button id="gridViewBtn" class="outline" aria-pressed="true" title="Grid view"><i class="fa-solid fa-grip"></i></button>
              <button id="listViewBtn" class="outline" aria-pressed="false" title="List view"><i class="fa-solid fa-list"></i></button>
            </div>
            <div class="sort" aria-label="Sort options">
              <label for="sortSelect" class="sr-only">Sort by</label>
              <select id="sortSelect" aria-label="Sort products">
                <option value="newest">Newest</option>
                <option value="price-low">Price: Low to high</option>
                <option value="price-high">Price: High to low</option>
                <option value="alpha">A → Z</option>
              </select>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:8px">
            <div id="filtersSummary" class="muted" aria-live="polite">Showing <strong id="visibleCount">12</strong> of 50 items</div>
            <button id="clearFiltersBtn" class="outline">Clear</button>
          </div>
        </div>

        <!-- PRODUCTS GRID (JS loads items into #productGrid) -->
        <section id="catalog" aria-label="Available dresses">
          <div id="productGrid" class="product-grid" role="list" aria-live="polite" aria-atomic="true" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px">
            <!-- JS will populate cards here (12 initially) -->
          </div>

          <div style="display:flex;justify-content:center;gap:12px;margin-top:16px">
            <button id="showMoreBtn" class="btn">Show more</button>
            <button id="showLessBtn" class="outline" style="display:none">Show less</button>
          </div>
        </section>

        <!-- quick tips / one-liners -->
        <aside aria-hidden="false" class="shop-notes" style="margin-top:18px;padding:12px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.04)">
          <p style="margin:0"><strong>Note:</strong> Each product is unique and only one piece is available. Quantities are fixed to 1. Checkout includes Paystack payments and receipts (PDF).</p>
        </aside>
      </div>
    </main>

    <!-- PRODUCT CARD TEMPLATE (hidden) -->
    <template id="productTemplate">
      <article class="product-card" role="listitem" aria-label="Product card" data-id="">
        <div class="card-media" style="position:relative">
          <img class="card-image" src="" alt="" style="width:100%;height:260px;object-fit:cover;border-radius:8px" />
          <div class="badge-available" aria-hidden="true" style="position:absolute;left:12px;top:12px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.9);font-weight:700">Only 1</div>
        </div>
        <div class="card-body" style="padding:10px;display:flex;flex-direction:column;gap:8px">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <h3 class="product-title" style="margin:0;font-size:15px"></h3>
            <div class="product-price" style="font-weight:800"></div>
          </div>
          <p class="product-desc" style="margin:0;color:#666;font-size:13px"></p>
          <div style="display:flex;gap:8px;align-items:center;margin-top:auto">
            <button class="btn add-to-cart" aria-label="Add to cart">Add to cart</button>
            <button class="outline view-detail" aria-label="View details">View</button>
          </div>
        </div>
      </article>
    </template>

    <!-- CART PANEL (slide-out) -->
    <aside id="cartPanel" class="cart-panel" role="dialog" aria-modal="true" aria-labelledby="cartTitle" style="display:none;position:fixed;right:0;top:0;height:100vh;width:420px;box-shadow:-10px 0 40px rgba(0,0,0,0.12);background:#fff;z-index:1200;padding:18px;overflow:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="cartTitle" style="margin:0">Your cart</h2>
        <button id="closeCartBtn" class="outline" aria-label="Close cart"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div id="cartItems" role="list" aria-live="polite" style="margin-top:12px;display:flex;flex-direction:column;gap:12px">
        <!-- JS inserts cart item rows here -->
        <div class="cart-empty" id="cartEmptyNote" style="padding:18px;border-radius:8px;border:1px dashed rgba(0,0,0,0.04);text-align:center">Your cart is empty</div>
      </div>

      <div class="cart-totals" style="margin-top:18px;border-top:1px solid rgba(0,0,0,0.04);padding-top:12px">
        <div style="display:flex;justify-content:space-between"><div>Subtotal</div><div id="cartSubtotal">GH₵ 0.00</div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px"><div>Processing fee</div><div id="cartProcessing">GH₵ 0.00</div></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-weight:800"><div>Total</div><div id="cartTotal">GH₵ 0.00</div></div>

        <div style="margin-top:14px;display:flex;gap:8px">
          <button id="checkoutBtn" class="btn" aria-controls="checkoutModal">Checkout</button>
          <button id="clearCartBtn" class="outline">Clear</button>
        </div>

        <div style="margin-top:10px;font-size:12px;color:#666">Secure checkout powered by Paystack</div>
      </div>

      <!-- small extras: discount code, notes -->
      <div style="margin-top:14px">
        <label for="couponInput" style="font-size:13px;color:#666">Discount code</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="couponInput" type="text" placeholder="Enter code (optional)" />
          <button id="applyCouponBtn" class="outline">Apply</button>
        </div>
      </div>

    </aside>

    <!-- CHECKOUT MODAL (aria-modal) -->
    <div id="checkoutModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="checkoutTitle" style="display:none">
      <div class="modal" role="document" style="max-width:820px;margin:36px auto;padding:18px;background:#fff;border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 id="checkoutTitle">Checkout</h2>
          <button id="closeCheckoutBtn" class="outline" aria-label="Close checkout"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
          <form id="checkoutForm" style="display:flex;flex-direction:column;gap:10px" autocomplete="on">
            <label>Full name <input id="buyerName" name="buyerName" type="text" required /></label>
            <label>Phone <input id="buyerPhone" name="buyerPhone" type="tel" required inputmode="tel" /></label>
            <label>Email <input id="buyerEmail" name="buyerEmail" type="email" required autocomplete="email" /></label>
            <label>Delivery address <textarea id="buyerAddress" name="buyerAddress" rows="2" placeholder="Enter delivery address or 'pickup'"></textarea></label>
            <label>Order note (optional) <textarea id="orderNote" rows="2" placeholder="E.g. leave at gate"></textarea></label>

            <div style="display:flex;gap:8px;margin-top:6px">
              <button id="payWithPaystack" type="button" class="btn">Pay with Paystack</button>
              <button id="checkoutCancel" type="button" class="outline">Cancel</button>
            </div>
          </form>

          <aside style="border-left:1px solid rgba(0,0,0,0.04);padding-left:12px">
            <h4 style="margin-top:0">Order summary</h4>
            <div id="checkoutSummary" style="display:flex;flex-direction:column;gap:6px">
              <!-- JS will inject summary rows -->
              <div style="display:flex;justify-content:space-between"><div>Items</div><div id="summaryItemsCount">0</div></div>
              <div style="display:flex;justify-content:space-between"><div>Subtotal</div><div id="summarySubtotal">GH₵ 0.00</div></div>
              <div style="display:flex;justify-content:space-between"><div>Processing</div><div id="summaryProcessing">GH₵ 0.00</div></div>
              <hr />
              <div style="display:flex;justify-content:space-between;font-weight:800"><div>Total</div><div id="summaryTotal">GH₵ 0.00</div></div>
            </div>
          </aside>
        </div>

      </div>
    </div>

    <!-- RECEIPT / CONFIRMATION MODAL -->
    <div id="receiptModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="receiptTitle" style="display:none">
      <div class="modal" role="document" style="max-width:720px;margin:36px auto;padding:18px;background:#fff;border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 id="receiptTitle">Receipt</h2>
          <button id="closeReceiptBtn" class="outline" aria-label="Close receipt"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div id="receiptContent" style="margin-top:12px">
          <!-- JS will fill this with order information -->
          <p class="muted">Receipt will appear here after successful payment. You can print or download a PDF.</p>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="downloadPdfBtn" class="btn"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
          <button id="printReceiptBtn" class="outline"><i class="fa-solid fa-print"></i> Print</button>
        </div>
      </div>
    </div>

    <!-- HISTORY MODAL (previous purchases + PDFs) -->
    <div id="historyModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="historyTitleModal" style="display:none">
      <div class="modal" role="document" style="max-width:900px;margin:36px auto;padding:18px;background:#fff;border-radius:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 id="historyTitleModal">Purchase history</h2>
          <button id="closeHistoryModalBtn" class="outline" aria-label="Close history"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div id="historyContent" style="margin-top:12px;max-height:60vh;overflow:auto">
          <p class="muted">No purchases yet. Completed orders will appear here.</p>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="clearHistoryBtn" class="outline">Clear history</button>
          <button id="closeHistoryFooterBtn" class="btn">Close</button>
        </div>
      </div>
    </div>

    <!-- CONTACT SECTION (phone, whatsapp, email only) -->
    <section id="contact" aria-label="Contact April Blossoms" style="padding:28px 16px;background:linear-gradient(180deg,#fff,#fafafa);margin-top:24px">
      <div class="container" style="max-width:1100px;margin:0 auto;display:flex;gap:18px;align-items:center;justify-content:space-between">
        <div>
          <h3 style="margin:0 0 6px 0">Contact us</h3>
          <p style="margin:0 0 10px 0;color:#666">We’re here to help with orders, shipping and sizing questions.</p>

          <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px">
            <li><a href="tel:0205237411" aria-label="Call April Blossoms"><i class="fa-solid fa-phone"></i> 0205237411</a></li>
            <li><a href="https://wa.me/233205237411" target="_blank" rel="noopener" aria-label="WhatsApp April Blossoms"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a></li>
            <li><a href="mailto:aprilblossoms@example.com" aria-label="Email April Blossoms"><i class="fa-solid fa-envelope"></i> aprilblossoms@example.com</a></li>
          </ul>
        </div>

        <div style="max-width:420px">
          <h4 style="margin:0 0 6px 0">Newsletter</h4>
          <p style="margin:0 0 8px 0;color:#666">Get first access to new one-off pieces</p>
          <form id="newsletterForm" style="display:flex;gap:8px">
            <input id="newsletterEmail" type="email" placeholder="Your email" aria-label="Enter email to subscribe" />
            <button id="subscribeBtn" class="btn" type="button">Subscribe</button>
          </form>
        </div>
      </div>
    </section>

    <!-- FOOTER (very stacked) -->
    <footer id="siteFooter" role="contentinfo" style="background:#0f1724;color:#fff;padding:36px 16px;margin-top:18px">
      <div class="container" style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:18px">
        <div>
          <img src="logo.jpg" alt="April Blossoms logo" style="height:56px;width:56px;border-radius:8px" />
          <h3 style="margin:8px 0 6px 0">April Blossoms</h3>
          <p style="color:rgba(255,255,255,0.8)">Unique kidswear — one piece per style. Designed with care.</p>
          <div style="margin-top:10px">
            <strong>Phone</strong><div><a href="tel:0205237411" style="color:inherit">0205237411</a></div>
            <strong>WhatsApp</strong><div><a href="https://wa.me/233205237411" style="color:inherit">Chat on WhatsApp</a></div>
            <strong>Email</strong><div><a href="mailto:aprilblossoms@example.com" style="color:inherit">aprilblossoms@example.com</a></div>
          </div>
        </div>

        <div>
          <h4 style="margin-top:0">Shop</h4>
          <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px">
            <li><a href="#catalog" style="color:inherit">All dresses</a></li>
            <li><a href="#catalog" style="color:inherit">New arrivals</a></li>
            <li><a href="#contact" style="color:inherit">Contact</a></li>
            <li><a href="#" style="color:inherit" id="returnsLink">Returns & exchange</a></li>
          </ul>
        </div>

        <div>
          <h4 style="margin-top:0">Company</h4>
          <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px">
            <li><a href="#" style="color:inherit">About us</a></li>
            <li><a href="#" style="color:inherit">Careers</a></li>
            <li><a href="#" style="color:inherit">Privacy policy</a></li>
            <li><a href="#" style="color:inherit">Terms of service</a></li>
          </ul>
        </div>

        <div>
          <h4 style="margin-top:0">Payments & trust</h4>
          <p style="margin:0 0 8px 0;color:rgba(255,255,255,0.9)">Secure payments via Paystack</p>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
           <img src="paystack.svg" alt="Paystack" style="height:36px" onerror="this.style.display='none'" />
           <img src="visa.svg" alt="Visa" style="height:24px" onerror="this.style.display='none'" />
            <img src="mastercard.svg" alt="Mastercard" style="height:24px" onerror="this.style.display='none'" />          </div>

          <h4 style="margin:8px 0 6px 0">Follow</h4>
          <div style="display:flex;gap:8px">
            <a href="#" aria-label="Instagram" class="social"><i class="fa-brands fa-instagram" aria-hidden="true"></i></a>
            <a href="#" aria-label="Facebook" class="social"><i class="fa-brands fa-facebook" aria-hidden="true"></i></a>
            <a href="#" aria-label="TikTok" class="social"><i class="fa-brands fa-tiktok" aria-hidden="true"></i></a>
          </div>
        </div>
      </div>

      <div style="border-top:1px solid rgba(255,255,255,0.06);margin-top:18px;padding-top:18px" class="container">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <small>© <span id="yearNow"></span> April Blossoms — All rights reserved</small>
          <div style="display:flex;gap:12px;align-items:center">
            <a href="#" style="color:rgba(255,255,255,0.7)">Security</a>
            <a href="#" style="color:rgba(255,255,255,0.7)">Sitemap</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- BACK TO TOP (sticky) -->
    <button id="backToTop" aria-label="Back to top" title="Back to top" style="position:fixed;right:18px;bottom:18px;display:none;border-radius:999px;padding:10px;z-index:1400">
      <i class="fa-solid fa-arrow-up"></i>
    </button>

    <!-- modal root placeholders (kept for scripts) -->
    <div id="modalRoot" aria-live="polite" style="display:none"></div>

  </div>

 <script>
(() => {
  /* =========================
     CONFIG
     ========================= */
  const CONFIG = {
    paystackPublicKey: 'pk_test_297586e51710e83d3c159bfe71ff45c7e23411fa',
    formspreeEndpoint: 'https://formspree.io/f/xrbyrqry',
    currencySymbol: 'GH₵',
    processingRate: 0.0295, // 2.95%
    localKeys: {
      cart: 'ab_cart_v1',
      history: 'ab_history_v1'
    },
    productPageSize: 12,
    historyLimit: 100
  };

  /* =========================
     UTILITIES
     ========================= */
  const $ = (sel, root = document) => root.querySelector(sel);
  const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const fmt = (n) => `${CONFIG.currencySymbol} ${Number(n).toFixed(2)}`;
  const nowISO = () => new Date().toISOString();

   function safeParseJSON(s, fallback) {
    try {
      const parsed = JSON.parse(s);
      // JSON.parse(null) -> null, we want fallback in that case
      return (parsed === null) ? fallback : parsed;
    } catch (e) {
      return fallback;
    }
  }

  function showToast(msg, opts = {}) {
    // simple toast: create container if missing
    let container = document.getElementById('ab_toast_container');
    if (!container) {
      container = document.createElement('div');
      container.id = 'ab_toast_container';
      container.style.position = 'fixed';
      container.style.right = '18px';
      container.style.bottom = '18px';
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.gap = '8px';
      container.style.zIndex = 99999;
      document.body.appendChild(container);
    }
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.background = '#fff';
    toast.style.border = '1px solid rgba(0,0,0,0.06)';
    toast.style.padding = '10px 12px';
    toast.style.borderRadius = '10px';
    toast.style.boxShadow = '0 8px 30px rgba(0,0,0,0.06)';
    toast.style.fontWeight = '700';
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(8px)';
      setTimeout(() => toast.remove(), 260);
    }, opts.duration || 2200);
    return toast;
  }

  /* =========================
     PRODUCTS (50 items provided)
     ========================= */
  const PRODUCTS = [
  { id: "DRESS-001", title: "Floral Ruffles", price: 40.00, description: "One-of-a-kind floral ruffle dress", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5700.JPG","IMG_5700.JPG"], available: true, createdAt: new Date(Date.now()-1*86400000).toISOString() },
  { id: "DRESS-002", title: "Sunshine Dress", price: 30.00, description: "Bright yellow play dress", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5701.JPG"], available: true, createdAt: new Date(Date.now()-2*86400000).toISOString() },
  { id: "DRESS-003", title: "Party Bow Dress", price: 35.00, description: "Elegant dress for special occasions", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5702.JPG","IMG_5702.JPG"], available: true, createdAt: new Date(Date.now()-3*86400000).toISOString() },
  { id: "DRESS-004", title: "Polka Play", price: 35.00, description: "Polka-dot twirl dress", sizes: ["0-3M","3-6M"], ageCategory: "4-5", images: ["IMG_5703.JPG"], available: true, createdAt: new Date(Date.now()-4*86400000).toISOString() },
  { id: "DRESS-005", title: "Candy Stripes", price: 35.00, description: "Soft striped cotton dress", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5704.JPG","IMG_5704.JPG"], available: true, createdAt: new Date(Date.now()-5*86400000).toISOString() },
  { id: "DRESS-006", title: "Meadow Tiny", price: 35.00, description: "Hand-stitched meadow pattern", sizes: ["5","6"], ageCategory: "4-5", images: ["IMG_5705.JPG"], available: true, createdAt: new Date(Date.now()-6*86400000).toISOString() },
  { id: "DRESS-007", title: "Lace Halo", price: 40.00, description: "Lace-trim party dress", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5706.JPG","IMG_5706.JPG"], available: true, createdAt: new Date(Date.now()-7*86400000).toISOString() },
  { id: "DRESS-008", title: "Seaside Sundress", price: 35.00, description: "Cool and breezy sun dress", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5707.JPG"], available: true, createdAt: new Date(Date.now()-8*86400000).toISOString() },
  { id: "DRESS-009", title: "Minty Bow", price: 100.00, description: "White Shirt with skirt", sizes: ["8","9"], ageCategory: "4-5", images: ["IMG_5708.JPG","IMG_5708.JPG"], available: true, createdAt: new Date(Date.now()-9*86400000).toISOString() },
  { id: "DRESS-010", title: "Rosette Charm", price: 35.00, description: "Rosette detailing, comfy fit", sizes: ["9","10"], ageCategory: "4-5", images: ["IMG_5709.JPG"], available: true, createdAt: new Date(Date.now()-10*86400000).toISOString() },

  { id: "DRESS-011", title: "Blossom Day", price: 30.00, description: "Lightweight blossom print dress", sizes: ["10","12"], ageCategory: "4-5", images: ["IMG_5710.JPG","IMG_5710.JPG"], available: true, createdAt: new Date(Date.now()-11*86400000).toISOString() },
  { id: "DRESS-012", title: "Vintage Coral", price: 40.00, description: "Retro coral dress with pockets", sizes: ["S","M"], ageCategory: "4-5", images: ["IMG_5711.JPG"], available: true, createdAt: new Date(Date.now()-12*86400000).toISOString() },
  { id: "DRESS-013", title: "Petal Puff", price: 30.00, description: "Petal-pattern puff sleeve dress", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5712.JPG","IMG_5712.JPG"], available: true, createdAt: new Date(Date.now()-13*86400000).toISOString() },
  { id: "DRESS-014", title: "Lemon Drop", price: 65.00, description: "Blue jeans trousers", sizes: ["5","6"], ageCategory: "4-5", images: ["IMG_5713.JPG"], available: true, createdAt: new Date(Date.now()-14*86400000).toISOString() },
  { id: "DRESS-015", title: "Bluebell Classic", price: 65.00, description: "Black jeans trousers", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5714.JPG","IMG_5714.JPG"], available: true, createdAt: new Date(Date.now()-15*86400000).toISOString() },
  { id: "DRESS-016", title: "Gingham Girl", price: 35.00, description: "Cute gingham for playdates", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5715.JPG"], available: true, createdAt: new Date(Date.now()-16*86400000).toISOString() },
  { id: "DRESS-017", title: "Velvet Holiday", price: 50.00, description: "Velvet holiday edition", sizes: ["8","9"], ageCategory: "4-5", images: ["IMG_5716.JPG","IMG_5716.JPG"], available: true, createdAt: new Date(Date.now()-17*86400000).toISOString() },
  { id: "DRESS-018", title: "Daisy Chain", price: 70.00, description: "Daisy print with soft lining", sizes: ["9","10"], ageCategory: "4-5", images: ["IMG_5717.JPG"], available: true, createdAt: new Date(Date.now()-18*86400000).toISOString() },
  { id: "DRESS-019", title: "Sunset Ombre", price: 50.00, description: "Ombre fade summer dress", sizes: ["10","12"], ageCategory: "4-5", images: ["IMG_5718.JPG","IMG_5718.JPG"], available: true, createdAt: new Date(Date.now()-19*86400000).toISOString() },
  { id: "DRESS-020", title: "Coral Petals", price: 70.00, description: "Coral floral with ruffled hem", sizes: ["S","M"], ageCategory: "4-5", images: ["IMG_5719.JPG"], available: true, createdAt: new Date(Date.now()-20*86400000).toISOString() },

  { id: "DRESS-021", title: "Lavender Mist", price: 28.00, description: "Soft lavender cotton dress", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5720.JPG","IMG_5720.JPG"], available: true, createdAt: new Date(Date.now()-21*86400000).toISOString() },
  { id: "DRESS-022", title: "Plaid Picnic", price: 28.00, description: "Cute plaid button dress", sizes: ["5","6"], ageCategory: "4-5", images: ["IMG_5720.JPG"], available: true, createdAt: new Date(Date.now()-22*86400000).toISOString() },
  { id: "DRESS-023", title: "Rosebud Twirl", price: 120.00, description: "Lightweight twirl skirt", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5721.JPG","IMG_5721.JPG"], available: true, createdAt: new Date(Date.now()-23*86400000).toISOString() },
  { id: "DRESS-024", title: "Mint Sprig", price: 80.00, description: "Refreshingly cool mint dress", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5722.JPG"], available: true, createdAt: new Date(Date.now()-24*86400000).toISOString() },
  { id: "DRESS-025", title: "Buttercup", price: 35.00, description: "Premium buttercup fabric", sizes: ["8","9"], ageCategory: "4-5", images: ["IMG_5723.JPG","IMG_5723.JPG"], available: true, createdAt: new Date(Date.now()-25*86400000).toISOString() },
  { id: "DRESS-026", title: "Peach Dream", price: 60.00, description: "Soft peach party dress", sizes: ["9","10"], ageCategory: "4-5", images: ["IMG_5724.JPG"], available: true, createdAt: new Date(Date.now()-26*86400000).toISOString() },
  { id: "DRESS-027", title: "Ivy Garden", price: 35.00, description: "Ivy print with tiny pleats", sizes: ["10","12"], ageCategory: "4-5", images: ["IMG_5725.JPG","IMG_5725.JPG"], available: true, createdAt: new Date(Date.now()-27*86400000).toISOString() },
  { id: "DRESS-028", title: "Ocean Breeze", price: 45.00, description: "Nautical details and stripes", sizes: ["S","M"], ageCategory: "4-5", images: ["IMG_5726.JPG"], available: true, createdAt: new Date(Date.now()-28*86400000).toISOString() },
  { id: "DRESS-029", title: "Lilac Lace", price: 35.00, description: "Delicate lilac lace overlay", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5727.JPG","IMG_5727.JPG"], available: true, createdAt: new Date(Date.now()-29*86400000).toISOString() },
  { id: "DRESS-030", title: "Maple Sweet", price: 40.00, description: "Warm tones for autumn play", sizes: ["5","6"], ageCategory: "4-5", images: ["IMG_5728.JPG"], available: true, createdAt: new Date(Date.now()-30*86400000).toISOString() },

  { id: "DRESS-031", title: "Cherry Puff", price: 40.00, description: "Cherry prints and puff sleeves", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5729.JPG","IMG_5729.JPG"], available: true, createdAt: new Date(Date.now()-31*86400000).toISOString() },
  { id: "DRESS-032", title: "Starry Night", price: 35.00, description: "Dark blue with star pattern", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5730.JPG"], available: true, createdAt: new Date(Date.now()-32*86400000).toISOString() },
  { id: "DRESS-033", title: "Palm Picnic", price: 35.00, description: "Tropical print for sunny days", sizes: ["8","9"], ageCategory: "4-5", images: ["IMG_5731.JPG","IMG_5731.JPG"], available: true, createdAt: new Date(Date.now()-33*86400000).toISOString() },
  { id: "DRESS-034", title: "Velvet Ribbon", price: 40.00, description: "Lux velvet with ribbon tie", sizes: ["9","10"], ageCategory: "4-5", images: ["IMG_5732.JPG"], available: true, createdAt: new Date(Date.now()-34*86400000).toISOString() },
  { id: "DRESS-035", title: "Rose Quartz", price: 35.00, description: "Soft pink, comfy cotton", sizes: ["10","12"], ageCategory: "4-5", images: ["IMG_5733.JPG","IMG_5733.JPG"], available: true, createdAt: new Date(Date.now()-35*86400000).toISOString() },
  { id: "DRESS-036", title: "Star Bloom", price: 30.00, description: "Star bloom pattern, breezy", sizes: ["S","M"], ageCategory: "4-5", images: ["IMG_5734.JPG"], available: true, createdAt: new Date(Date.now()-36*86400000).toISOString() },
  { id: "DRESS-037", title: "Meadow Stitch", price: 40.00, description: "Detailed stitching, floral", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5735.JPG","IMG_5735.JPG"], available: true, createdAt: new Date(Date.now()-37*86400000).toISOString() },
  { id: "DRESS-038", title: "Denim Dolly", price: 50.00, description: "Soft denim dress with buttons", sizes: ["5","6"], ageCategory: "4-5", images: ["IMG_5736.JPG"], available: true, createdAt: new Date(Date.now()-38*86400000).toISOString() },
  { id: "DRESS-039", title: "Citrine Bloom", price: 65.00, description: "Sunny citrine color", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5737.JPG","IMG_5737.JPG"], available: true, createdAt: new Date(Date.now()-39*86400000).toISOString() },
  { id: "DRESS-040", title: "Cloud Puff", price: 25.00, description: "Puffy clouds print", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5738.JPG"], available: true, createdAt: new Date(Date.now()-40*86400000).toISOString() },

  { id: "DRESS-041", title: "Mint Melody", price: 28.00, description: "Light mint with trims", sizes: ["8","9"], ageCategory: "4-5", images: ["IMG_5739.JPG","IMG_5739.JPG"], available: true, createdAt: new Date(Date.now()-41*86400000).toISOString() },
  { id: "DRESS-042", title: "Petite Pearl", price: 25.00, description: "Pearl button detail", sizes: ["9","10"], ageCategory: "4-5", images: ["IMG_5740.JPG"], available: true, createdAt: new Date(Date.now()-42*86400000).toISOString() },
  { id: "DRESS-043", title: "Coral Breeze", price: 35.00, description: "Soft coral shade", sizes: ["10","12"], ageCategory: "4-5", images: ["IMG_5741.JPG","IMG_5741.JPG"], available: true, createdAt: new Date(Date.now()-43*86400000).toISOString() },
  { id: "DRESS-044", title: "Pineapple Pop", price: 30.00, description: "Fun pineapple print", sizes: ["4","5"], ageCategory: "4-5", images: ["IMG_5742.JPG"], available: true, createdAt: new Date(Date.now()-44*86400000).toISOString() },
  { id: "DRESS-045", title: "Willow Whisper", price: 40.00, description: "Earthy willow tones", sizes: ["5","6"], ageCategory: "4-5", images: ["IMG_5743.JPG","IMG_5743.JPG"], available: true, createdAt: new Date(Date.now()-45*86400000).toISOString() },
  { id: "DRESS-046", title: "Sunbeam Tuck", price: 35.00, description: "Tucked waist, sunny print", sizes: ["6","7"], ageCategory: "4-5", images: ["IMG_5744.JPG"], available: true, createdAt: new Date(Date.now()-46*86400000).toISOString() },
  { id: "DRESS-047", title: "Peppermint Twist", price: 30.00, description: "Mint stripes and soft collar", sizes: ["7","8"], ageCategory: "4-5", images: ["IMG_5745.JPG","IMG_5745.JPG"], available: true, createdAt: new Date(Date.now()-47*86400000).toISOString() },
  { id: "DRESS-048", title: "Dotted Dreams", price: 60.00, description: "Subtle dotted pattern", sizes: ["8","9"], ageCategory: "4-5", images: ["IMG_5746.JPG"], available: true, createdAt: new Date(Date.now()-48*86400000).toISOString() },
  { id: "DRESS-049", title: "Little Luxe", price: 80.00, description: "Tiny luxe finish", sizes: ["9","10"], ageCategory: "7-8", images: ["IMG_5747.JPG","IMG_5747.JPG"], available: true, createdAt: new Date(Date.now()-49*86400000).toISOString() },
  { id: "DRESS-050", title: "Pocket Garden", price: 40.00, description: "Playful pockets and cotton", sizes: ["10","12"], ageCategory: "4-5", images: ["IMG_5748.JPG"], available: true, createdAt: new Date(Date.now()-50*86400000).toISOString() }
  ];

  /* =========================
     STATE MANAGEMENT
     ========================= */
  let state = {
    products: PRODUCTS.slice(), // clone
    visibleCount: CONFIG.productPageSize,
    cart: loadCart(),           // array of cart entries {id, productSnapshot, addedAt}
    history: loadHistory()      // array of receipts
  };

  /* =========================
     STORAGE HELPERS
     ========================= */
  function loadCart() {
    const raw = localStorage.getItem(CONFIG.localKeys.cart);
   const parsed = safeParseJSON(raw, []);
   return Array.isArray(parsed) ? parsed : [];
  }
  function saveCart() {
    localStorage.setItem(CONFIG.localKeys.cart, JSON.stringify(state.cart));
    // update visible UI with the canonical functions we have
    try {
      renderCartItems();
      updateCartTotals();
      updateCartBadge();
    } catch (err) {
      // If something unexpected happens, log it but don't crash the app
      // (this prevents UI update errors from bubbling up)
      // eslint-disable-next-line no-console
      console.warn('saveCart UI update error', err);
    }
  }
  function clearCart() {
    state.cart = [];
    saveCart();
  }

  function loadHistory() {
    const raw = localStorage.getItem(CONFIG.localKeys.history);
    const parsed = safeParseJSON(raw, []);
    return Array.isArray(parsed) ? parsed : [];
  }
  function saveHistory() {
    localStorage.setItem(CONFIG.localKeys.history, JSON.stringify(state.history));
    updateHistoryBadge();
  }
  function addHistoryEntry(entry) {
    // entry: receipt object
    state.history.unshift(Object.assign({ savedAt: nowISO() }, entry));
    // limit
    if (state.history.length > CONFIG.historyLimit) state.history.length = CONFIG.historyLimit;
    saveHistory();
  }
  function clearHistory() {
    state.history = [];
    saveHistory();
  }

  /* =========================
     UI UPDATES: BADGES & COUNTS
     ========================= */
  function updateCartBadge() {
    const count = state.cart.length;
    const el = document.getElementById('cartCount');
    if (el) {
      el.textContent = String(count);
      el.style.display = count > 0 ? 'inline-block' : 'none';
    }
  }
  function updateHistoryBadge() {
    const count = state.history.length;
    const el = document.getElementById('historyCount');
    if (el) {
      el.textContent = String(count);
      el.style.display = count > 0 ? 'inline-block' : 'none';
    }
  }

  function updateVisibleCount() {
    const vc = Math.min(state.visibleCount, state.products.length);
    const el = document.getElementById('visibleCount');
    if (el) el.textContent = String(vc);
  }

  /* =========================
     PRODUCT RENDERING
     ========================= */
  function renderProducts() {
    const grid = document.getElementById('productGrid');
    if (!grid) return;
    grid.innerHTML = '';
    const tpl = document.getElementById('productTemplate');
    const slice = state.products.slice(0, state.visibleCount);
    slice.forEach(prod => {
      const frag = tpl.content.cloneNode(true);
      const art = frag.querySelector('.product-card');
      art.dataset.id = prod.id;
      const img = frag.querySelector('.card-image');
      img.src = prod.images && prod.images.length ? prod.images[0] : 'placeholder.jpg';
      img.alt = prod.title;
      frag.querySelector('.product-title').textContent = prod.title;
      frag.querySelector('.product-price').textContent = fmt(prod.price);
      frag.querySelector('.product-desc').textContent = prod.description;
      const addBtn = frag.querySelector('.add-to-cart');
      addBtn.addEventListener('click', () => addToCart(prod.id));
      const viewBtn = frag.querySelector('.view-detail');
      viewBtn.addEventListener('click', () => showProductQuickView(prod));
      grid.appendChild(frag);
    });

    updateVisibleCount();
    // toggle show/hide buttons
    const showMoreBtn = document.getElementById('showMoreBtn');
    const showLessBtn = document.getElementById('showLessBtn');
    if (!showMoreBtn || !showLessBtn) return;
    if (state.visibleCount >= state.products.length) {
      showMoreBtn.style.display = 'none';
      showLessBtn.style.display = 'inline-block';
    } else {
      showMoreBtn.style.display = 'inline-block';
      showLessBtn.style.display = 'none';
    }
  }

  /* =========================
     HERO SLIDESHOW
     ========================= */
  function heroInit() {
    const slides = $$('.hero-slide');
    const dots = $$('.hero-dot');
    let idx = 0;
    let timer = null;
    const total = slides.length;

    function show(i) {
      slides.forEach((s, k) => {
        const hidden = k !== i;
        s.setAttribute('aria-hidden', hidden ? 'true' : 'false');
        s.style.opacity = hidden ? '0' : '1';
        s.style.transition = 'opacity 420ms ease';
      });
      dots.forEach((d, k) => d.setAttribute('aria-pressed', String(k===i)));
      idx = i;
    }

    function next() { show((idx+1) % total); }
    function prev() { show((idx-1+total) % total); }

    // wire controls
    $('#heroNext')?.addEventListener('click', () => { stopAuto(); next(); });
    $('#heroPrev')?.addEventListener('click', () => { stopAuto(); prev(); });
    dots.forEach(d => d.addEventListener('click', (e) => { stopAuto(); show(Number(e.currentTarget.dataset.slide)); }));

    // auto play
    function startAuto() { timer = setInterval(next, 4500); }
    function stopAuto() { if (timer) { clearInterval(timer); timer = null; } }
    startAuto();

    // keyboard support
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight') { stopAuto(); next(); }
      if (e.key === 'ArrowLeft') { stopAuto(); prev(); }
    });
  }

  /* =========================
     CART LOGIC
     ========================= */
  function findProductById(id) {
    return state.products.find(p => p.id === id);
  }

  function addToCart(productId) {
    const product = findProductById(productId);
    if (!product) return showToast('Product not found');
    // enforce one-of-a-kind: if already in cart or sold (history contains order for this product), block
    const inCart = state.cart.find(c => c.id === productId);
    const soldPreviously = state.history.some(h => (h.items || []).some(it => it && it.id === productId));
    if (inCart) return showToast('This item is already in your cart (only one allowed).');
    if (soldPreviously) return showToast('Sorry — this item was already purchased.');

    // Add snapshot to cart
    const snapshot = {
      id: product.id,
      title: product.title,
      price: product.price,
      image: (product.images && product.images[0]) || '',
      addedAt: nowISO()
    };
    state.cart.push({ id: product.id, product: snapshot });
    saveCart();
    showToast(`${product.title} added to cart`);
  }

  function removeFromCart(productId) {
    state.cart = state.cart.filter(c => c.id !== productId);
    saveCart();
    showToast('Removed from cart');
  }

  function renderCartItems() {
    const container = document.getElementById('cartItems');
    if (!container) return;
    container.innerHTML = '';
    if (!state.cart.length) {
      const empty = document.createElement('div');
      empty.id = 'cartEmptyNote';
      empty.className = 'cart-empty';
      empty.style.padding = '18px';
      empty.style.borderRadius = '8px';
      empty.style.border = '1px dashed rgba(0,0,0,0.04)';
      empty.style.textAlign = 'center';
      empty.textContent = 'Your cart is empty';
      container.appendChild(empty);
      updateCartTotals();
      return;
    }

    state.cart.forEach((entry) => {
      const row = document.createElement('div');
      row.style.display = 'flex';
      row.style.gap = '8px';
      row.style.alignItems = 'center';
      row.style.border = '1px solid rgba(0,0,0,0.04)';
      row.style.padding = '8px';
      row.style.borderRadius = '8px';

      const img = document.createElement('img');
      img.src = entry.product.image || 'placeholder.jpg';
      img.alt = entry.product.title;
      img.style.width = '64px';
      img.style.height = '64px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '6px';

      const meta = document.createElement('div');
      meta.style.flex = '1';
      meta.innerHTML = `<div style="font-weight:700">${escapeHtml(entry.product.title)}</div><div style="font-size:13px;color:#666">${fmt(entry.product.price)}</div>`;

      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.flexDirection = 'column';
      actions.style.gap = '6px';
      const removeBtn = document.createElement('button');
      removeBtn.className = 'outline';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => removeFromCart(entry.id));
      const buyNow = document.createElement('button');
      buyNow.className = 'btn';
      buyNow.textContent = 'Buy now';
      buyNow.addEventListener('click', () => {
        // open checkout and prefill this single item only
        openCartPanel();
        openCheckoutModal(true, entry);
      });
      actions.appendChild(buyNow);
      actions.appendChild(removeBtn);

      row.appendChild(img);
      row.appendChild(meta);
      row.appendChild(actions);
      container.appendChild(row);
    });

    // small "save for later" area can be added here later
    updateCartTotals();
  }

  /* =========================
     CART TOTALS & PROCESSING
     ========================= */
  function calculateCartTotals() {
    // all math in pennies (cents) for accuracy
    const subtotalCents = state.cart.reduce((acc, c) => {
      const cents = Math.round(Number(c.product.price || 0) * 100);
      return acc + cents;
    }, 0);
    const processingCents = Math.round(subtotalCents * CONFIG.processingRate);
    const totalCents = subtotalCents + processingCents;
    return {
      subtotal: subtotalCents / 100,
      processing: processingCents / 100,
      total: totalCents / 100,
      subtotalCents, processingCents, totalCents
    };
  }

  function updateCartTotals() {
    const { subtotal, processing, total } = calculateCartTotals();
    $('#cartSubtotal').textContent = fmt(subtotal);
    $('#cartProcessing').textContent = fmt(processing);
    $('#cartTotal').textContent = fmt(total);
    $('#summarySubtotal') && ($('#summarySubtotal').textContent = fmt(subtotal));
    $('#summaryProcessing') && ($('#summaryProcessing').textContent = fmt(processing));
    $('#summaryTotal') && ($('#summaryTotal').textContent = fmt(total));
    $('#summaryItemsCount') && ($('#summaryItemsCount').textContent = String(state.cart.length));
    updateCartBadge();
  }

  /* =========================
     CART PANEL UI (open/close)
     ========================= */
  function openCartPanel() {
    const panel = document.getElementById('cartPanel');
    if (!panel) return;
    panel.style.display = 'block';
    panel.setAttribute('aria-hidden', 'false');
    // trap focus loosely by focusing close button
    $('#closeCartBtn')?.focus();
    renderCartItems();
  }
  function closeCartPanel() {
    const panel = document.getElementById('cartPanel');
    if (!panel) return;
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden', 'true');
    $('#cartBtn')?.focus();
  }

  /* =========================
     PRODUCT QUICK VIEW (modalRoot)
     ========================= */
  function showProductQuickView(product) {
    const modalRoot = document.getElementById('modalRoot');
    if (!modalRoot) return;
    modalRoot.style.display = 'block';
    modalRoot.innerHTML = `
      <div class="modal-backdrop" id="pvBackdrop" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:12000">
        <div class="modal" role="document" style="width:720px;max-width:96%;background:#fff;padding:16px;border-radius:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">${escapeHtml(product.title)}</h3>
            <button id="pvClose" class="outline" aria-label="Close quick view"><i class="fa-solid fa-xmark"></i></button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div>
              <img src="${product.images && product.images.length ? product.images[0] : 'placeholder.jpg'}" alt="${escapeHtml(product.title)}" style="width:100%;height:320px;object-fit:cover;border-radius:8px" />
            </div>
            <div>
              <p style="margin-top:0">${escapeHtml(product.description)}</p>
              <p style="font-weight:800;font-size:18px">${fmt(product.price)}</p>
              <p style="color:#666;font-size:13px">Age: ${escapeHtml(product.ageCategory || '')}</p>
              <div style="display:flex;gap:8px;margin-top:12px">
                <button id="pvAdd" class="btn">Add to cart</button>
                <button id="pvBuy" class="outline">Buy now</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    $('#pvAdd')?.addEventListener('click', () => { addToCart(product.id); closeModalRoot(); });
    $('#pvBuy')?.addEventListener('click', () => { addToCart(product.id); openCheckoutModal(); closeModalRoot(); });
    $('#pvClose')?.addEventListener('click', closeModalRoot);
    document.getElementById('pvBackdrop')?.addEventListener('click', (e) => { if (e.target.id === 'pvBackdrop') closeModalRoot(); });
  }
  function closeModalRoot() { const root = document.getElementById('modalRoot'); if (!root) return; root.style.display = 'none'; root.innerHTML = ''; }

  /* =========================
     CHECKOUT FLOW
     ========================= */
  function openCheckoutModal(singleItem = false, singleEntry = null) {
    const ck = document.getElementById('checkoutModal');
    if (!ck) return;
    ck.style.display = 'block';
    // prefill summary depending on context
    if (singleItem && singleEntry) {
      // temporarily set cart to the single item for the checkout summary
      state._checkoutTemp = state.cart; // backup
      state.cart = [{ id: singleEntry.id, product: singleEntry.product }];
    } else {
      state._checkoutTemp = null;
    }
    renderCartItems();
    updateCartTotals();
    // focus first input
    $('#buyerName')?.focus();
  }

  function closeCheckoutModal() {
    const ck = document.getElementById('checkoutModal');
    if (!ck) return;
    ck.style.display = 'none';
    // restore cart if we used a temp
    if (state._checkoutTemp) {
      state.cart = state._checkoutTemp;
      state._checkoutTemp = null;
      saveCart();
    }
  }

  function validateCheckoutForm() {
    const name = ($('#buyerName') && $('#buyerName').value.trim()) || '';
    const phone = ($('#buyerPhone') && $('#buyerPhone').value.trim()) || '';
    const email = ($('#buyerEmail') && $('#buyerEmail').value.trim()) || '';
    const address = ($('#buyerAddress') && $('#buyerAddress').value.trim()) || '';
    if (!name) { alert('Enter a buyer name'); $('#buyerName')?.focus(); return null; }
    if (!phone) { alert('Enter a phone'); $('#buyerPhone')?.focus(); return null; }
    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email)) { alert('Enter a valid email'); $('#buyerEmail')?.focus(); return null; }
    // address can be 'pickup' as per requirement, so allow
    return { name, phone, email, address, note:($('#orderNote') && $('#orderNote').value.trim()) || '' };
  }

  async function startPaymentFlow() {
    const formData = validateCheckoutForm();
    if (!formData) return;
    if (!state.cart.length) { alert('Your cart is empty'); return; }
    const totals = calculateCartTotals();
    const amountPesewas = Math.round(totals.total * 100);

    // build metadata & items snapshot
    const items = state.cart.map(c => ({ id: c.id, title: c.product.title, price: c.product.price }));

    const metadata = {
      custom_fields: [
        { display_name: 'Phone', variable_name: 'phone', value: formData.phone },
        { display_name: 'Items', variable_name: 'items', value: JSON.stringify(items.map(it => ({ id: it.id, title: it.title, price: it.price }))) },
      ]
    };

    const reference = `AB-${Date.now()}-${Math.floor(Math.random()*90000+10000)}`;

    // ensure Paystack available
    if (typeof PaystackPop === 'undefined' || !CONFIG.paystackPublicKey) {
      // fallback: simulate payment for local dev/test with confirmation
      const simulate = confirm('Paystack is not available. Simulate a successful payment? (for testing only)');
      if (!simulate) return;
      const fakeResponse = { reference, status: 'success' };
      await finalizeSuccessfulPayment(fakeResponse, { formData, items, totals });
      return;
    }

    const handler = PaystackPop.setup({
      key: CONFIG.paystackPublicKey,
      email: formData.email,
      amount: amountPesewas,
      currency: 'GHS',
      ref: reference,
      metadata,
      onClose: function() {
        showToast('Payment popup closed');
      },
      callback: async function(response) {
        // response.reference
        await finalizeSuccessfulPayment(response, { formData, items, totals });
      }
    });

    handler.openIframe();
  }

  /* finalize after successful payment: save history, send formspree, show receipt modal */
  async function finalizeSuccessfulPayment(paystackResponse, { formData, items, totals }) {
    // build receipt object
    const receipt = {
      orderId: paystackResponse.reference || `AB-${Date.now()}`,
      payRef: paystackResponse.reference || '',
      buyerName: formData.name,
      buyerEmail: formData.email,
      phone: formData.phone,
      address: formData.address || '',
      items: items || [],
      subtotal: totals.subtotal,
      processingFee: totals.processing,
      totalCharged: totals.total,
      timestamp: nowISO()
    };

    // Save to history (and remove purchased items from cart)
    addHistoryEntry(receipt);

    // Remove purchased items from cart (and persist)
    const purchasedIds = items.map(it => it.id);
    state.cart = state.cart.filter(c => !purchasedIds.includes(c.id));
    saveCart();

    // Send to Formspree (best-effort)
    sendToFormspree(receipt).catch(() => { /* ignore errors */ });

    // Show receipt modal
    showReceiptModal(receipt);

    showToast('Payment successful — receipt ready');
    closeCheckoutModal();
    closeCartPanel();
  }

  /* =========================
     Formspree submission
     ========================= */
  async function sendToFormspree(receipt) {
    if (!CONFIG.formspreeEndpoint) return;
    try {
      const payload = {
        order_id: receipt.orderId,
        payment_reference: receipt.payRef,
        buyer_name: receipt.buyerName,
        buyer_email: receipt.buyerEmail,
        phone: receipt.phone,
        address: receipt.address,
        items: JSON.stringify(receipt.items),
        subtotal: String(receipt.subtotal),
        processing_fee: String(receipt.processingFee),
        total_charged: String(receipt.totalCharged),
        timestamp: receipt.timestamp,
        message: `Order ${receipt.orderId} by ${receipt.buyerName}`
      };
      const res = await fetch(CONFIG.formspreeEndpoint, {
        method: 'POST',
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'cors'
      });
      if (!res.ok) throw new Error('Formspree returned non-OK');
      showToast('Order data sent to store (Formspree)');
      return res.json().catch(() => ({}));
    } catch (err) {
      console.warn('Formspree failed', err);
      showToast('Could not send order to Formspree (check endpoint).', { duration: 4000 });
    }
  }

  /* =========================
     RECEIPT UI & PDF
     ========================= */
  function showReceiptModal(receipt) {
    const rm = document.getElementById('receiptModal');
    if (!rm) return;
    const content = document.getElementById('receiptContent');
    if (!content) return;
    content.innerHTML = buildReceiptHTML(receipt);
    rm.style.display = 'block';
    $('#downloadPdfBtn')?.addEventListener('click', () => downloadPdf(receipt));
    $('#printReceiptBtn')?.addEventListener('click', () => printReceipt(receipt));
  }
  function closeReceiptModal() {
    const rm = document.getElementById('receiptModal');
    if (!rm) return;
    rm.style.display = 'none';
  }

  function buildReceiptHTML(receipt) {
    const itemsHtml = (receipt.items || []).map(it => `<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${escapeHtml(it.title)} (${escapeHtml(it.id)})</div><div>${fmt(it.price)}</div></div>`).join('');
    return `
      <div style="padding:6px 0">
        <div style="display:flex;justify-content:space-between"><div><strong>Order</strong></div><div><code>${escapeHtml(receipt.orderId)}</code></div></div>
        <div style="margin-top:8px">${itemsHtml}</div>
        <hr/>
        <div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>${fmt(receipt.subtotal)}</div></div>
        <div style="display:flex;justify-content:space-between"><div>Processing fee</div><div>${fmt(receipt.processingFee)}</div></div>
        <div style="display:flex;justify-content:space-between;font-weight:800;margin-top:6px"><div>Total</div><div>${fmt(receipt.totalCharged)}</div></div>
        <div style="margin-top:10px;font-size:13px;color:#666">Buyer: ${escapeHtml(receipt.buyerName)} — ${escapeHtml(receipt.phone)} — ${escapeHtml(receipt.buyerEmail)}</div>
        <div style="margin-top:6px;font-size:12px;color:#666">Note: Delivery charges (if any) will be communicated separately.</div>
      </div>
    `;
  }

  async function downloadPdf(receipt) {
    if (!window.jspdf || !window.jspdf.jsPDF) {
      alert('PDF generator (jsPDF) not available.');
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'a4' });
    const w = doc.internal.pageSize.getWidth();
    let y = 40;
    doc.setFontSize(16);
    doc.text('April Blossoms — Receipt', w/2, y, { align: 'center' });
    y += 24;
    doc.setFontSize(10);
    doc.text(`Order: ${receipt.orderId}`, 40, y); y += 16;
    doc.text(`Buyer: ${receipt.buyerName} — ${receipt.phone} — ${receipt.buyerEmail}`, 40, y); y += 18;

    doc.setDrawColor(230); doc.line(40, y, w-40, y); y += 12;
    (receipt.items || []).forEach(it => {
      doc.text(it.title, 40, y);
      doc.text(fmt(it.price), w - 100, y, { align: 'right' });
      y += 16;
    });
    y += 6;
    doc.text('Subtotal', 40, y); doc.text(fmt(receipt.subtotal), w - 100, y, { align: 'right' }); y += 14;
    doc.text('Processing fee', 40, y); doc.text(fmt(receipt.processingFee), w - 100, y, { align: 'right' }); y += 14;
    doc.setFontSize(12); doc.setFont(undefined, 'bold');
    doc.text('Total', 40, y); doc.text(fmt(receipt.totalCharged), w - 100, y, { align: 'right' });
    const fname = `AprilBlossoms_${receipt.orderId || Date.now()}.pdf`;
    doc.save(fname);
    showToast('PDF downloaded');
  }

  function printReceipt(receipt) {
    const win = window.open('', '_blank', 'noopener');
    const html = `
      <!doctype html><html><head><meta charset="utf-8"><title>Receipt ${receipt.orderId}</title></head><body>${buildReceiptHTML(receipt)}</body></html>
    `;
    if (!win) { alert('Unable to open print window'); return; }
    win.document.write(html);
    win.document.close();
    win.focus();
    setTimeout(()=>win.print(), 300);
  }

  /* =========================
     HISTORY MODAL: render + actions
     ========================= */
  function renderHistoryModal() {
    const modal = document.getElementById('historyModal');
    const content = document.getElementById('historyContent');
    if (!modal || !content) return;
    if (!state.history.length) {
      content.innerHTML = '<p class="muted">No purchases yet. Completed orders will appear here.</p>';
      return;
    }
    const rows = state.history.map((h, idx) => {
      const when = new Date(h.savedAt || h.timestamp || '').toLocaleString();
      const total = fmt(h.totalCharged || h.total || 0);
      const items = (h.items || []).map(it => `${escapeHtml(it.title)} (${escapeHtml(it.id)})`).join('<br/>');
      return `<div style="border-top:1px solid rgba(0,0,0,0.04);padding:10px;display:flex;justify-content:space-between;gap:12px">
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(h.buyerName || '')} — <code>${escapeHtml(h.orderId || h.payRef || '')}</code></div>
          <div style="font-size:13px;color:#666">${items}</div>
          <div style="font-size:12px;color:#666;margin-top:6px">${when}</div>
        </div>
        <div style="min-width:140px;text-align:right">
          <div style="font-weight:800">${total}</div>
          <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:8px">
            <button class="outline history-view" data-idx="${idx}">View</button>
            <button class="outline history-download" data-idx="${idx}">PDF</button>
            <button class="outline history-delete" data-idx="${idx}">Delete</button>
          </div>
        </div>
      </div>`;
    }).join('');
    content.innerHTML = rows;

    // wire actions
    $$('.history-view', content).forEach(btn => btn.addEventListener('click', (e) => {
      const idx = Number(e.currentTarget.dataset.idx);
      const entry = state.history[idx];
      if (!entry) return showToast('Entry not found');
      showReceiptModal(entry);
    }));
    $$('.history-download', content).forEach(btn => btn.addEventListener('click', (e) => {
      const idx = Number(e.currentTarget.dataset.idx);
      const entry = state.history[idx];
      if (!entry) return showToast('Entry not found');
      downloadPdf(entry);
    }));
    $$('.history-delete', content).forEach(btn => btn.addEventListener('click', (e) => {
      const idx = Number(e.currentTarget.dataset.idx);
      if (!confirm('Delete this saved purchase?')) return;
      state.history.splice(idx,1); saveHistory(); renderHistoryModal();
    }));
  }

  /* =========================
     BACK TO TOP
     ========================= */
  function backToTopInit() {
    const b = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      if (window.scrollY > window.innerHeight) b.style.display = 'block';
      else b.style.display = 'none';
    });
    b.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
  }

  /* =========================
     SEARCH / SORT / FILTERS
     ========================= */
  function applySearchAndSort() {
    const q = ($('#searchInput') && $('#searchInput').value.trim().toLowerCase()) || '';
    const sort = ($('#sortSelect') && $('#sortSelect').value) || 'newest';
    let list = PRODUCTS.slice();

    if (q) {
      list = list.filter(p => (p.title + ' ' + p.description + ' ' + (p.id || '')).toLowerCase().includes(q));
    }

    // sort
    if (sort === 'newest') list.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    if (sort === 'price-low') list.sort((a,b) => a.price - b.price);
    if (sort === 'price-high') list.sort((a,b) => b.price - a.price);
    if (sort === 'alpha') list.sort((a,b) => a.title.localeCompare(b.title));

    state.products = list;
    // reset visible count to default
    state.visibleCount = CONFIG.productPageSize;
    renderProducts();
  }

  /* =========================
     HELPERS & SAFETY
     ========================= */
  function escapeHtml(s='') {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  /* =========================
     EVENT BINDINGS
     ========================= */
  function attachUIEvents() {
    // header buttons
    $('#cartBtn')?.addEventListener('click', openCartPanel);
    $('#closeCartBtn')?.addEventListener('click', closeCartPanel);
    $('#clearCartBtn')?.addEventListener('click', () => { if (!state.cart.length) return; if (!confirm('Clear cart?')) return; clearCart(); showToast('Cart cleared'); });

    // checkout modal wiring
    $('#checkoutBtn')?.addEventListener('click', () => openCheckoutModal());
    $('#checkoutCancel')?.addEventListener('click', closeCheckoutModal);
    $('#closeCheckoutBtn')?.addEventListener('click', closeCheckoutModal);
    $('#payWithPaystack')?.addEventListener('click', startPaymentFlow);

    // receipt modal close
    $('#closeReceiptBtn')?.addEventListener('click', closeReceiptModal);

    // history modal open/close
    $('#historyBtn')?.addEventListener('click', () => { renderHistoryModal(); $('#historyModal').style.display = 'block'; });
    $('#closeHistoryModalBtn')?.addEventListener('click', () => $('#historyModal').style.display = 'none');
    $('#closeHistoryFooterBtn')?.addEventListener('click', () => $('#historyModal').style.display = 'none');
    $('#clearHistoryBtn')?.addEventListener('click', () => { if (!confirm('Clear purchase history?')) return; clearHistory(); renderHistoryModal(); });

    // search and sort
    $('#searchBtn')?.addEventListener('click', applySearchAndSort);
    $('#searchInput')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') applySearchAndSort(); });
    $('#sortSelect')?.addEventListener('change', applySearchAndSort);

    // show more / less
    $('#showMoreBtn')?.addEventListener('click', () => { state.visibleCount = Math.min(state.products.length, state.visibleCount + CONFIG.productPageSize); renderProducts(); });
    $('#showLessBtn')?.addEventListener('click', () => { state.visibleCount = CONFIG.productPageSize; renderProducts(); });

    // newsletter
    $('#subscribeBtn')?.addEventListener('click', () => {
      const email = ($('#newsletterEmail') && $('#newsletterEmail').value.trim()) || '';
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email)) { showToast('Enter a valid email'); return; }
      // naive local subscription demo (in production: call your subscription API)
      showToast('Thanks — subscribed!');
      $('#newsletterEmail').value = '';
    });

    // coupon apply (demo)
    $('#applyCouponBtn')?.addEventListener('click', () => {
      const code = ($('#couponInput') && $('#couponInput').value.trim()) || '';
      if (!code) { showToast('Enter a coupon'); return; }
      // demo: accept 'APRIL10' for 10% off (example). This implementation will modify processing fee as a simple demo.
      if (code.toUpperCase() === 'APRIL10') {
        showToast('Coupon applied: 10% off (demo) - applied to subtotal');
        // apply discount by adjusting each cart item price proportionally (demo only)
        state.cart = state.cart.map(c => {
          const newPrice = Math.round((c.product.price * 0.9) * 100) / 100;
          return { ...c, product: { ...c.product, price: newPrice } };
        });
        saveCart();
      } else {
        showToast('Coupon not recognized');
      }
    });

    // back to top
    backToTopInit();

    // close overlays on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeCartPanel();
        closeCheckoutModal();
        closeReceiptModal();
        $('#historyModal').style.display = 'none';
        closeModalRoot();
      }
    });

    // cart pop when clicking outside (optional) - not auto-close to avoid bad UX
  }

  /* =========================
     INIT
     ========================= */
  function init() {
    // Render initial UI
    updateHistoryBadge();
    renderProducts();
    heroInit();
    attachUIEvents();
    updateCartBadge();
    renderCartItems();
    updateCartTotals();
    // set year in footer
    const yNow = new Date().getFullYear();
    const yn = document.getElementById('yearNow');
    if (yn) yn.textContent = String(yNow);
  }

  // run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

 
  // Expose some helpers to window for debugging in dev
  window.AB = {
    state,
    addToCart,
    removeFromCart,
    clearCart,
    saveCart,
    loadCart,
    PRODUCTS,
    finalizeSuccessfulPayment,
    downloadPdf,
    showToast
  };

})();
</script>
</body>


</html>
