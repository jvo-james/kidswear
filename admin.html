<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tiny Threads — Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg: #fffaf6;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #ff6b8a;
      --shadow: 0 10px 30px rgba(16,24,40,0.06);
      --radius: 12px;
      --max-width: 1100px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#fffaf6, #fff7f0);color:#0f172a}
    .container{width:92%;max-width:var(--max-width);margin:26px auto}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{margin:0;font-size:1.1rem}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent), #ffd166);border:0;padding:8px 12px;border-radius:10px;color:white;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn.outline{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted);font-weight:700}
    .panel{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search{padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);min-width:220px}
    table{width:100%;border-collapse:collapse;font-size:0.95rem}
    thead th{text-align:left;padding:10px 8px;border-bottom:1px solid rgba(15,23,42,0.05);font-weight:700}
    tbody td{padding:10px 8px;border-bottom:1px dashed rgba(15,23,42,0.03);vertical-align:middle}
    .thumb{width:64px;height:48px;object-fit:cover;border-radius:8px}
    .tiny{padding:6px 8px;border-radius:8px;font-weight:700}
    .muted{color:var(--muted)}
    .form-row{margin-bottom:8px}
    label{display:block;font-weight:700;margin-bottom:6px;font-size:0.85rem}
    input[type="text"], input[type="number"], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)}
    textarea{min-height:110px;resize:vertical}
    .images-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .images-preview .img-wrap{position:relative}
    .images-preview img{width:84px;height:64px;object-fit:cover;border-radius:8px}
    .img-remove{position:absolute;right:4px;top:4px;background:rgba(0,0,0,0.6);color:white;border-radius:999px;padding:4px;font-size:12px;border:0;cursor:pointer}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .actions {flex-direction:row-reverse} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <a href="index.html" class="btn outline" target="_blank" title="Open store (index.html)"><i class="fa fa-store"></i> Open Store</a>
        <div>
          <h1>Tiny Threads — Admin</h1>
          <div class="muted">Manage products, images and availability (changes write to localStorage)</div>
        </div>
      </div>

      <div class="actions">
        <button id="export-btn" class="btn outline tiny" title="Export products to JSON"><i class="fa fa-download"></i> Export</button>
        <button id="import-btn" class="btn tiny" title="Import from JSON (paste)"><i class="fa fa-upload"></i> Import</button>
        <button id="new-btn" class="btn tiny" title="Add new product"><i class="fa fa-plus"></i> New product</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: product list -->
      <section class="panel">
        <div class="toolbar">
          <input id="search" class="search" placeholder="Search by id, title or description..." />
          <select id="filter-availability" style="padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">
            <option value="">All availability</option>
            <option value="available">Available</option>
            <option value="sold">Sold / Unavailable</option>
          </select>
          <div style="margin-left:auto" class="muted">Storage key: <strong>tiny_products_v1</strong></div>
        </div>

        <div id="list-wrap">
          <table id="products-table" aria-live="polite">
            <thead>
              <tr>
                <th>Preview</th>
                <th>Title & ID</th>
                <th>Price</th>
                <th>Sizes</th>
                <th>Category</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="products-tbody">
              <!-- populated by JS -->
            </tbody>
          </table>
          <div id="empty" class="empty" style="display:none">
            No products found. Use <strong>New product</strong> to add, or <strong>Import</strong> JSON.
          </div>
        </div>
      </section>

      <!-- RIGHT: product form / tools -->
      <aside class="panel">
        <h3 id="form-title">Create product</h3>

        <form id="product-form">
          <input type="hidden" id="product-id" />
          <div class="form-row">
            <label for="product-title">Title</label>
            <input id="product-title" type="text" placeholder="Floral Ruffles" required />
          </div>

          <div class="form-row">
            <label for="product-price">Price (₵)</label>
            <input id="product-price" type="number" step="0.01" placeholder="35.00" required />
          </div>

          <div class="form-row">
            <label for="product-desc">Description</label>
            <textarea id="product-desc" placeholder="Short description"></textarea>
          </div>

          <div class="form-row">
            <label for="product-sizes">Sizes (comma-separated)</label>
            <input id="product-sizes" type="text" placeholder="4,5,6 or S,M" />
          </div>

          <div class="form-row">
            <label for="product-age">Age category</label>
            <input id="product-age" type="text" placeholder="4-5" />
          </div>

          <div class="form-row">
            <label for="product-available">Available?</label>
            <select id="product-available">
              <option value="true">Yes (available)</option>
              <option value="false">No (sold/unavailable)</option>
            </select>
          </div>

          <div class="form-row">
            <label for="product-images">Images (choose files)</label>
            <input id="product-images" type="file" accept="image/*" multiple />
            <div class="images-preview" id="images-preview"></div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="save-btn" class="btn" type="submit"><i class="fa fa-save"></i> Save</button>
            <button id="reset-btn" class="btn outline" type="button">Reset</button>
          </div>
        </form>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(15,23,42,0.06)" />

        <div style="display:flex;gap:8px;flex-direction:column">
          <button id="apply-btn" class="btn" title="Write products to localStorage and notify other tabs"><i class="fa fa-check"></i> Apply / Publish changes</button>
          <button id="reload-btn" class="btn outline" title="Reload products from storage">Reload from storage</button>
          <button id="clear-storage-btn" class="btn outline" title="Clear stored products (use carefully)">Clear products</button>
        </div>

      </aside>
    </div>

    <footer>
      <small>Changes update the page's localStorage key <strong>tiny_products_v1</strong>. To see changes on the store page, reload <code>index.html</code> or open it in a new tab.</small>
    </footer>
  </div>

<script>
/* Admin tool for managing tiny_products_v1 */
const STORAGE_KEY = 'tiny_products_v1';
const LAST_UPDATE_KEY = 'tiny_products_v1_last_update';

const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

let products = [];

/* ---------- Utilities ---------- */
function uid(prefix='P') {
  return prefix + '-' + Math.random().toString(36).slice(2,9).toUpperCase();
}
function formatPrice(p){ return '₵' + Number(p||0).toFixed(2); }
function nowISO(){ return new Date().toISOString(); }
function toast(msg, t=2200){
  const d = document.createElement('div');
  d.textContent = msg;
  d.style.position='fixed';
  d.style.left='50%';
  d.style.transform='translateX(-50%)';
  d.style.bottom='30px';
  d.style.background='rgba(10,10,10,0.9)';
  d.style.color='white';
  d.style.padding='10px 14px';
  d.style.borderRadius='999px';
  d.style.zIndex=9999;
  document.body.appendChild(d);
  setTimeout(()=> d.style.opacity = '0.0', t-300);
  setTimeout(()=> d.remove(), t);
}

/* ---------- Persistence ---------- */
function loadProductsFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    return parsed;
  } catch(e) {
    console.error('Failed to parse products', e);
    return [];
  }
}
function saveProductsToStorage(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  // write a timestamp so other tabs can detect a change
  localStorage.setItem(LAST_UPDATE_KEY, new Date().toISOString());
  toast('Products saved to localStorage');
}

/* ---------- Rendering ---------- */
const tbody = $('#products-tbody');
const emptyEl = $('#empty');

function renderProducts(filterText='', availability=''){
  tbody.innerHTML = '';
  const q = (filterText||'').trim().toLowerCase();
  let list = products.slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  if (availability === 'available') list = list.filter(p => p.available);
  if (availability === 'sold') list = list.filter(p => !p.available);

  if (q) {
    list = list.filter(p => (p.title||'').toLowerCase().includes(q) || (p.id||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q));
  }

  if (list.length === 0) {
    $('#products-table').style.display = 'none';
    emptyEl.style.display = '';
    return;
  } else {
    $('#products-table').style.display = '';
    emptyEl.style.display = 'none';
  }

  list.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="width:92px">
        <img class="thumb" src="${(p.images && p.images[0]) || ''}" alt="${p.title || p.id}" onerror="this.style.background='#f3f4f6'" />
      </td>
      <td>
        <div style="font-weight:800">${p.title || '(no title)'}</div>
        <div class="muted" style="font-size:0.85rem">${p.id}</div>
        <div style="max-width:360px;color:var(--muted);font-size:0.9rem;margin-top:6px">${(p.description||'').slice(0,120)}</div>
      </td>
      <td>${formatPrice(p.price)}</td>
      <td>${(p.sizes || []).join(', ')}</td>
      <td>${p.ageCategory || ''} <div style="margin-top:6px;color:${p.available ? 'var(--success, #10b981)' : '#ff6b6b'};font-weight:700">${p.available ? 'Available' : 'Unavailable'}</div></td>
      <td style="white-space:nowrap">${new Date(p.createdAt||'').toLocaleDateString() }</td>
      <td style="white-space:nowrap">
        <button class="tiny" data-action="edit" data-id="${p.id}"><i class="fa fa-pen"></i> Edit</button>
        <button class="tiny btn outline" data-action="toggle" data-id="${p.id}"><i class="fa fa-exchange"></i> Toggle</button>
        <button class="tiny btn outline" data-action="delete" data-id="${p.id}"><i class="fa fa-trash"></i> Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // attach handlers
  $$('[data-action="edit"]').forEach(btn => btn.onclick = () => openEditForm(btn.dataset.id));
  $$('[data-action="delete"]').forEach(btn => btn.onclick = () => deleteProduct(btn.dataset.id));
  $$('[data-action="toggle"]').forEach(btn => btn.onclick = () => toggleAvailability(btn.dataset.id));
}

/* ---------- Form handling (create/edit) ---------- */
const form = $('#product-form');
const idInput = $('#product-id');
const titleInput = $('#product-title');
const priceInput = $('#product-price');
const descInput = $('#product-desc');
const sizesInput = $('#product-sizes');
const ageInput = $('#product-age');
const availInput = $('#product-available');
const imagesInput = $('#product-images');
const imagesPreview = $('#images-preview');
const formTitle = $('#form-title');

let stagingImages = []; // array of data-urls

function resetForm(){
  idInput.value = '';
  titleInput.value = '';
  priceInput.value = '';
  descInput.value = '';
  sizesInput.value = '';
  ageInput.value = '';
  availInput.value = 'true';
  imagesInput.value = '';
  stagingImages = [];
  imagesPreview.innerHTML = '';
  formTitle.textContent = 'Create product';
}

function openEditForm(id){
  const p = products.find(x => x.id === id);
  if (!p) return toast('Product not found');
  idInput.value = p.id;
  titleInput.value = p.title || '';
  priceInput.value = p.price || '';
  descInput.value = p.description || '';
  sizesInput.value = (p.sizes || []).join(',');
  ageInput.value = p.ageCategory || '';
  availInput.value = p.available ? 'true' : 'false';
  imagesPreview.innerHTML = '';
  stagingImages = (p.images || []).slice();
  renderImagesPreview();
  formTitle.textContent = 'Edit product';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* image preview helpers */
function renderImagesPreview(){
  imagesPreview.innerHTML = '';
  stagingImages.forEach((src, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'img-wrap';
    wrap.innerHTML = `<img src="${src}" alt="img-${idx}" /><button class="img-remove" data-idx="${idx}" title="Remove image"><i class="fa fa-times"></i></button>`;
    imagesPreview.appendChild(wrap);
  });
  // wire remove
  $$('.img-remove', imagesPreview).forEach(btn => btn.onclick = () => {
    const i = Number(btn.dataset.idx);
    stagingImages.splice(i, 1);
    renderImagesPreview();
  });
}

/* read files and convert to data URLs */
imagesInput.addEventListener('change', async (e) => {
  const files = Array.from(e.target.files || []);
  for (const f of files) {
    const data = await fileToDataURL(f);
    if (data) stagingImages.push(data);
  }
  renderImagesPreview();
  imagesInput.value = '';
});

/* file -> dataURL */
function fileToDataURL(file){
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => resolve(null);
    reader.readAsDataURL(file);
  });
}

/* form submit save */
form.addEventListener('submit', (ev) => {
  ev.preventDefault();
  const id = idInput.value || uid('DRESS');
  const title = (titleInput.value || '').trim();
  const price = Number(priceInput.value || 0);
  const description = (descInput.value || '').trim();
  const sizes = (sizesInput.value || '').split(',').map(s => s.trim()).filter(Boolean);
  const ageCategory = (ageInput.value || '').trim();
  const available = availInput.value === 'true';

  if (!title) return toast('Title required');
  if (!price) return toast('Valid price required');

  const existingIdx = products.findIndex(p => p.id === id);
  const now = new Date().toISOString();
  const newProduct = {
    id,
    title,
    price,
    description,
    sizes,
    ageCategory,
    images: stagingImages.slice(),
    available,
    createdAt: existingIdx === -1 ? now : (products[existingIdx].createdAt || now)
  };

  if (existingIdx === -1) {
    products.unshift(newProduct); // newest first
    toast('Product created');
  } else {
    products[existingIdx] = newProduct;
    toast('Product updated');
  }

  renderProducts($('#search').value, $('#filter-availability').value);
  resetForm();
});

/* delete product */
function deleteProduct(id){
  if (!confirm('Delete this product? This cannot be undone.')) return;
  products = products.filter(p => p.id !== id);
  renderProducts($('#search').value, $('#filter-availability').value);
  toast('Product deleted');
}

/* toggle availability */
function toggleAvailability(id){
  const idx = products.findIndex(p => p.id === id);
  if (idx === -1) return;
  products[idx].available = !products[idx].available;
  renderProducts($('#search').value, $('#filter-availability').value);
  toast(`Availability: ${products[idx].available ? 'Available' : 'Unavailable'}`);
}

/* ---------- Tools: import / export / clear / apply ---------- */
$('#export-btn').addEventListener('click', () => {
  const data = JSON.stringify(products, null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tiny_products_v1_export_${(new Date()).toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast('Export prepared');
});

$('#import-btn').addEventListener('click', async () => {
  const txt = prompt('Paste product JSON here (an array of product objects).');
  if (!txt) return;
  try {
    const parsed = JSON.parse(txt);
    if (!Array.isArray(parsed)) { toast('Expected an array of products'); return; }
    // simple validation: ensure each item has id/title/price
    const invalid = parsed.find(p => !p.id || !p.title || (p.price === undefined));
    if (invalid) { toast('One or more items missing id/title/price'); return; }
    products = parsed.slice();
    renderProducts();
    toast('Imported products (not yet published). Click Apply to write to storage.');
  } catch(e) {
    console.error(e);
    toast('Invalid JSON');
  }
});

$('#apply-btn').addEventListener('click', () => {
  // write to storage and notify
  saveProductsToStorage(products);
  toast('Published. Reload store to see changes (index.html).');
});

$('#reload-btn').addEventListener('click', () => {
  products = loadProductsFromStorage();
  renderProducts($('#search').value, $('#filter-availability').value);
  resetForm();
  toast('Reloaded from storage');
});

$('#clear-storage-btn').addEventListener('click', () => {
  if (!confirm('Clear all stored products? This will remove the products key from localStorage.')) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.setItem(LAST_UPDATE_KEY, new Date().toISOString());
  products = [];
  renderProducts();
  resetForm();
  toast('Storage cleared');
});

/* new product button */
$('#new-btn').addEventListener('click', () => {
  resetForm();
  formTitle.scrollIntoView({behavior: 'smooth'});
});

/* search / filter handlers */
$('#search').addEventListener('input', (e) => {
  renderProducts(e.target.value, $('#filter-availability').value);
});
$('#filter-availability').addEventListener('change', (e) => {
  renderProducts($('#search').value, e.target.value);
});

/* reset button */
$('#reset-btn').addEventListener('click', (e) => { e.preventDefault(); resetForm(); });

/* listen for external storage changes (other tab) and reload */
window.addEventListener('storage', (ev) => {
  if (ev.key === LAST_UPDATE_KEY) {
    // another tab published changes — reload after a small delay
    setTimeout(() => {
      products = loadProductsFromStorage();
      renderProducts($('#search').value, $('#filter-availability').value);
      toast('Products updated from another tab');
    }, 150);
  }
});

/* initialize */
(function init(){
  products = loadProductsFromStorage();
  renderProducts();
})();
</script>
</body>
</html>
